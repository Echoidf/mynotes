import{_ as o}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as e,c,a as n,b as s,d as t,e as a,r as l}from"./app.40f19e5e.js";const u={},k=a('<h2 id="记一次mysql自增id发生跳跃的问题" tabindex="-1"><a class="header-anchor" href="#记一次mysql自增id发生跳跃的问题" aria-hidden="true">#</a> 记一次MySQL自增ID发生跳跃的问题</h2><p>在对大规模数据进行分页查询测试性能时，我使用了MySQL的蠕虫复制快速生成了百万级别的数据，但是发现了一个很奇怪的问题，先回顾一下我的操作：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>\n  <span class="token identifier"><span class="token punctuation">`</span>empno<span class="token punctuation">`</span></span> <span class="token keyword">mediumint</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>ename<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>job<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>mgr<span class="token punctuation">`</span></span> <span class="token keyword">mediumint</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>hiredate<span class="token punctuation">`</span></span> <span class="token keyword">date</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>sal<span class="token punctuation">`</span></span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>comm<span class="token punctuation">`</span></span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token identifier"><span class="token punctuation">`</span>deptno<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7369</span><span class="token punctuation">,</span> <span class="token string">&#39;SMITH&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;CLERK&#39;</span><span class="token punctuation">,</span> <span class="token number">7902</span><span class="token punctuation">,</span> <span class="token string">&#39;1990-12-17&#39;</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7499</span><span class="token punctuation">,</span> <span class="token string">&#39;ALLEN&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;SALESMAN&#39;</span><span class="token punctuation">,</span> <span class="token number">7698</span><span class="token punctuation">,</span> <span class="token string">&#39;1991-02-20&#39;</span><span class="token punctuation">,</span> <span class="token number">1600</span><span class="token punctuation">,</span> <span class="token number">300.00</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7521</span><span class="token punctuation">,</span> <span class="token string">&#39;WARD&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;SALESMAN&#39;</span><span class="token punctuation">,</span> <span class="token number">7698</span><span class="token punctuation">,</span> <span class="token string">&#39;1991-02-22&#39;</span><span class="token punctuation">,</span> <span class="token number">1250</span><span class="token punctuation">,</span> <span class="token number">500.00</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7566</span><span class="token punctuation">,</span> <span class="token string">&#39;JONES&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;MANAGER&#39;</span><span class="token punctuation">,</span> <span class="token number">7839</span><span class="token punctuation">,</span> <span class="token string">&#39;1991-04-02&#39;</span><span class="token punctuation">,</span> <span class="token number">2975</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span><span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7654</span><span class="token punctuation">,</span> <span class="token string">&#39;MARTIN&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;SALESMAN&#39;</span><span class="token punctuation">,</span> <span class="token number">7698</span><span class="token punctuation">,</span> <span class="token string">&#39;1991-09-28&#39;</span><span class="token punctuation">,</span> <span class="token number">1250</span><span class="token punctuation">,</span> <span class="token number">1400.00</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7698</span><span class="token punctuation">,</span> <span class="token string">&#39;BLAKE&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;MANAGER&#39;</span><span class="token punctuation">,</span> <span class="token number">7839</span><span class="token punctuation">,</span> <span class="token string">&#39;1991-05-01&#39;</span><span class="token punctuation">,</span> <span class="token number">2850</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7782</span><span class="token punctuation">,</span> <span class="token string">&#39;CLARK&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;MANAGER&#39;</span><span class="token punctuation">,</span> <span class="token number">7839</span><span class="token punctuation">,</span> <span class="token string">&#39;1991-06-09&#39;</span><span class="token punctuation">,</span> <span class="token number">2450</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7788</span><span class="token punctuation">,</span> <span class="token string">&#39;SCOTT&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ANALYST&#39;</span><span class="token punctuation">,</span> <span class="token number">7566</span><span class="token punctuation">,</span> <span class="token string">&#39;1997-04-19&#39;</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7839</span><span class="token punctuation">,</span> <span class="token string">&#39;KING&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PRESIDENT&#39;</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">&#39;1991-11-17&#39;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7844</span><span class="token punctuation">,</span> <span class="token string">&#39;TURNER&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;SALESMAN&#39;</span><span class="token punctuation">,</span> <span class="token number">7698</span><span class="token punctuation">,</span> <span class="token string">&#39;1991-09-08&#39;</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7900</span><span class="token punctuation">,</span> <span class="token string">&#39;JAMES&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;CLERK&#39;</span><span class="token punctuation">,</span> <span class="token number">7698</span><span class="token punctuation">,</span> <span class="token string">&#39;1991-12-03&#39;</span><span class="token punctuation">,</span> <span class="token number">950</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7902</span><span class="token punctuation">,</span> <span class="token string">&#39;FORD&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ANALYST&#39;</span><span class="token punctuation">,</span> <span class="token number">7566</span><span class="token punctuation">,</span> <span class="token string">&#39;1991-12-03&#39;</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7934</span><span class="token punctuation">,</span> <span class="token string">&#39;MILLER&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;CLERK&#39;</span><span class="token punctuation">,</span> <span class="token number">7782</span><span class="token punctuation">,</span> <span class="token string">&#39;1992-01-23&#39;</span><span class="token punctuation">,</span> <span class="token number">1300</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>emp</code>表中有13条记录，此时再创建一个新表<code>test</code>作为测试表，并从<code>emp</code>表中查询数据插入到测试表中：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test\n<span class="token punctuation">(</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \n sal <span class="token keyword">DOUBLE</span><span class="token punctuation">,</span> job <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n deptno <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>\n\n <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test\n<span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> sal<span class="token punctuation">,</span> job<span class="token punctuation">,</span>deptno<span class="token punctuation">)</span>\n<span class="token keyword">SELECT</span> ename<span class="token punctuation">,</span> sal<span class="token punctuation">,</span> job<span class="token punctuation">,</span> deptno <span class="token keyword">FROM</span> emp<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时测试表<code>test</code>中也有了13条记录</p><p>接下来进行蠕虫复制，反复执行如下sql，<code>test</code>表的数据行数就会以指数级成倍增加：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> sal<span class="token punctuation">,</span> job<span class="token punctuation">,</span>deptno<span class="token punctuation">)</span> <span class="token keyword">SELECT</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> sal<span class="token punctuation">,</span> job<span class="token punctuation">,</span>deptno <span class="token keyword">FROM</span> test<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>但是在测试时却发现以这种方式批量插入的数据发生了id跳跃，可以看到第二次插入数据时直接从16开始了：</p><p><img src="https://s2.loli.net/2023/03/13/xIwMnyAvN9fRku4.png" alt="image.png"></p><p>我以<code>INSERT INTO ... SELECT ...</code>的方式插入数据时并没有指定插入id值，而是希望它以MySQL的自增ID方式自动生成</p><p>为什么会出现ID跳跃的情况呢？</p><p>首先要了解下MySQL是如何保证<strong>自增主键的单调递增属性</strong>的，这与<mark>MySQL的自增锁模式有关——<code>innodb_autoinc_lock_mode</code></mark></p><p>查看这个全局配置：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 查看自增锁模式配置</span>\n<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;innodb_autoinc_lock_mode&#39;</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>Mysql 8.0开始默认是 2，之前的版本默认是1</p><p>该配置有0/1/2三种可选值</p>',17),i={href:"https://www.cnblogs.com/detectiveHLH/p/14832940.html",target:"_blank",rel:"noopener noreferrer"},r=a("<ul><li><p><strong>innodb_autoinc_lock_mode=0</strong></p><p><strong>传统锁模式【traditional 】</strong></p><blockquote><p>当我们向包含了 <code>AUTO_INCREMENT</code> 列的表中插入数据时，都会持有这么一个特殊的表锁——自增锁（AUTO-INC），并且当语句执行完之后就会释放。这样一来可以保证单个语句内生成的自增值是连续的。</p><p>但是这样一来，传统模式的弊端就自然暴露出来了，如果有多个事务并发的执行 <code>INSERT</code> 操作，<code>AUTO-INC</code>的存在会使得 MySQL 的性能略有下降，因为同时只能执行一条 <code>INSERT</code> 语句。</p></blockquote></li><li><p><strong>innodb_autoinc_lock_mode=1</strong></p><p><strong>连续模式【Consecutive】</strong></p><blockquote><p>在锁模式处于连续模式下时，如果 <code>INSERT</code> 语句能够提前确定插入的数据量，则可以不用获取自增锁，举个例子，像 <code>INSERT INTO</code> 这种简单的、能提前确认数量的新增语句，就不会使用自增锁，这个很好理解，在自增值上，我可以直接把这个 <code>INSERT</code> 语句所需要的空间流出来，就可以继续执行下一个语句了。通过持有所需要数量的自增值的互斥锁（轻量锁）来避免使用表锁，这个锁仅在分配过程中持有，不会持续到语句结束。</p><p>但是如果 <code>INSERT</code> 语句不能提前确认数据量，则还是会去获取自增锁。例如像 <code>INSERT INTO ... SELECT ...</code> 这种语句，<code>INSERT</code> 的值来源于另一个 <code>SELECT</code> 语句，会使用表锁直到语句结束，同时只有一个语句持有表锁。</p></blockquote></li><li><p><strong>innodb_autoinc_lock_mode=2</strong></p><p><strong>交叉模式【Interleaved】</strong></p><blockquote><p>交叉模式（Interleaved）下，所有的 <code>INSERT</code> 语句，包含 <code>INSERT</code> 和 <code>INSERT INTO ... SELECT</code> ，都不会使用 <code>AUTO-INC</code> 自增锁，而是使用较为轻量的 <code>mutex</code> 锁。这样一来，多条 <code>INSERT</code> 语句可以并发的执行，这也是三种锁模式中扩展性最好的一种。</p><p>并发执行所带来的副作用就是单个 <code>INSERT</code> 的自增值并不连续，因为 <code>AUTO_INCREMENT</code> 的值分配会在多个 <code>INSERT</code> 语句中来回交叉的执行。</p><p>优点很明确，缺点是在并发的情况下无法保证数据一致性，</p></blockquote></li></ul>",1),d={href:"https://www.cnblogs.com/jojop/p/13982679.html",target:"_blank",rel:"noopener noreferrer"},m=a("<p>如何理解交叉模式的缺陷，先了解下MySQL的<code>binlog</code>机制，<code>Binlog</code>一般用于MySQL的数据复制/主从同步。</p><p>在 MySQL 中 Binlog 的格式有 3 种，分别是：</p><ul><li><strong>Statement</strong> 基于语句，只记录对数据做了修改的SQL语句，能够有效的减少binlog的数据量，提高读取、基于binlog重放的性能</li><li><strong>Row</strong> 只记录被修改的行，所以Row记录的binlog日志量一般来说会比Statement格式要多。基于Row的binlog日志非常完整、清晰，记录了所有数据的变动，但是缺点是可能会非常多，例如一条<code>update</code>语句，有可能是所有的数据都有修改；再例如<code>alter table</code>之类的，修改了某个字段，同样的每条记录都有改动。</li><li><strong>Mixed</strong> Statement和Row的结合，例如像<code>alter table</code>之类的对表结构的修改，采用Statement格式。其余的对数据的修改例如<code>update</code>和<code>delete</code>采用Row格式进行记录。</li></ul><p>如果 MySQL 采用的格式为 <code>Statement</code> ，那么 MySQL 的主从同步实际上同步的就是一条一条的 SQL 语句。如果此时我们采用了交叉模式，那么并发情况下 <code>INSERT</code> 语句的执行顺序就无法得到保障。</p><p><code>INSERT</code> 同时交叉执行，并且 <code>AUTO_INCREMENT</code> 交叉分配将会直接导致主从之间同行的数据<strong>主键 ID 不同</strong>。而这对主从同步来说是灾难性的。</p><p>再回过头来看进行蠕虫复制的时候为什么会发生ID跳跃呢？</p><p>我的MySQL版本是5.7，默认是连续模式，每次会预申请多余的id，申请个数与当前的数据记录行数N有关，每次都会申请2N个id，当下一次insert时会把从多余的id中取最大值作为自增的起始点，我画了一个图来表示：</p><table><thead><tr><th>当前数据行数</th><th>申请id</th><th>插入操作记录序列</th></tr></thead><tbody><tr><td>N=1</td><td>2</td><td><mark>1，2，</mark>3 （申请的id是2和3，3是多余的id）</td></tr><tr><td>N=2</td><td>4</td><td><mark>3，4，</mark>5，6 （5，6是多余的id）</td></tr><tr><td>N=4</td><td>8</td><td><mark>6，7，8，9，</mark>10，11，12，13 （10-13是多余的id）</td></tr><tr><td>N=8</td><td>16</td><td><mark>13，14，... ，19，20，</mark>21，... ，27，28 （21-28是多余的id）</td></tr></tbody></table><p>这就能解释为什么蠕虫复制如果初始值为1的情况下，id的序列会是：【1，2，3，4，6，7，8，9，13，……】</p><p><strong>如何修改锁模式呢？</strong></p><p>在MySQL的配置文件（Windows是my.ini，Linux是my.cnf）中进行配置即可：<code>innodb_autoinc_lock_mode=1</code>，需要重启MySQL服务</p>",11);function b(N,y){const p=l("ExternalLinkIcon");return e(),c("div",null,[k,n("p",null,[s("参考文章："),n("a",i,[s("深入剖析 MySQL 自增锁 - detectiveHLH - 博客园 (cnblogs.com)"),t(p)])]),r,n("p",null,[s("关于MySQL的锁机制，可以看下这篇博客（引用）："),n("a",d,[s("MySQL中的锁机制 - 周二鸭 - 博客园"),t(p)])]),m])}const g=o(u,[["render",b],["__file","MySQL自增ID跳跃问题.html.vue"]]);export{g as default};
